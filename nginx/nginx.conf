events {
    worker_connections 1024;
}

http {
    upstream jupyter_backend {
        server jupyterlab:8888;
    }
    
    upstream auth_backend {
        server auth:5000;
    }
    
    upstream webapp_backend {
        server webapp:80;
    }

    # Zona de autenticación interna para auth_request
    auth_request_set $auth_status $upstream_status;
    auth_request_set $auth_user $upstream_http_x_user;

    server {
        listen 80;
        server_name chomsky;
        
        # Ruta raíz - 404 silencioso (sin mensaje)
        location = / {
            return 404;
        }
        
        # Ruta de logout - redirigir a /pe-ctic/logout
        location = /logout {
            return 302 /pe-ctic/logout;
        }
        
        # Endpoint interno para verificar sesión (usado por auth_request)
        # Usamos /pe-ctic/api/verify-session para que las cookies se pasen correctamente
        location = /pe-ctic/api/verify-session {
            internal;
            proxy_pass http://auth_backend/api/verify-session;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header X-Original-Method $request_method;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Pasar todas las cookies al backend
            proxy_set_header Cookie $http_cookie;
        }
        
        # Archivos estáticos de webapp bajo /pe-ctic/static/ (más específico primero)
        location /pe-ctic/static/ {
            proxy_pass http://webapp_backend/static/;
            proxy_set_header Host $host;
        }
        
        # Archivos desde shared/users bajo /pe-ctic/webapp/files/ (más específico)
        location ~ ^/pe-ctic/webapp/files/(.*)$ {
            proxy_pass http://webapp_backend/files/$1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Rutas de notebooks de webapp bajo /pe-ctic/webapp/notebook/ (más específico)
        location ~ ^/pe-ctic/webapp/notebook/(.*)$ {
            proxy_pass http://webapp_backend/notebook/$1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Webapp bajo /pe-ctic/webapp/ (más específico primero)
        location /pe-ctic/webapp/ {
            proxy_pass http://webapp_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Ruta específica para autenticación (pe-ctic) - debe ir después de las rutas más específicas
        location /pe-ctic/ {
            proxy_pass http://auth_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Script-Name /pe-ctic;
            # Reescribir cookies para que funcionen en todas las rutas
            proxy_cookie_path / /;
        }

        # JUPYTERLAB - PROTEGIDO CON AUTH_REQUEST
        # Todas las rutas de Jupyter requieren autenticación
        location ~ ^/(lab|api|terminals|files|static/components|static/lab|favicons|favicon\.ico) {
            # Verificar sesión antes de permitir acceso
            auth_request /pe-ctic/api/verify-session;
            
            # Si no hay sesión válida, redirigir al login
            error_page 401 = @auth_required;
            
            proxy_pass http://jupyter_backend$request_uri;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;
            
            # Configuraciones adicionales para Jupyter
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Server $host;
            proxy_set_header X-Forwarded-Port $server_port;
        }
        
        # Redirección cuando se requiere autenticación
        location @auth_required {
            return 302 /pe-ctic/;
        }

        # Cualquier otra ruta no definida va a 404 silencioso
        location / {
            return 404;
        }
    }
}
